<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyMaven Link Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
</head>
<body>
    <main class="container">
        <h1>Link Tracker Dashboard</h1>

        <article>
            <header>Create New Link</header>
            <form id="shortenForm">
                <label for="url">Enter Long URL</label>
                <input type="url" id="url" name="url" placeholder="https://stellarstylesandmore.etsy.com..." required>
                <button type="submit">Shorten</button>
            </form>
            <div id="result"></div>
        </article>

        <article>
            <header>Your Data Stream</header>
            <figure>
                <table>
                    <thead>
                        <tr>
                            <th>Short Code</th>
                            <th>Original URL</th>
                            <th>Total Clicks</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="statsTable">
                        </tbody>
                </table>
            </figure>
        </article>
    </main>

    <script>
        // 1. Handle Form Submit
        document.getElementById('shortenForm').onsubmit = async (e) => {
            e.preventDefault();
            const url = document.getElementById('url').value;
            
            try {
                const response = await fetch('/shorten', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url: url})
                });
                
                if (!response.ok) {
                    throw new Error('Failed to shorten URL');
                }
                
                const data = await response.json();
                document.getElementById('result').innerHTML = `
                    Success! Your link: <a href="${data.short_url}" target="_blank">${data.short_url}</a>
                `;
                loadStats(); // Refresh table
            } catch (error) {
                document.getElementById('result').innerHTML = `
                    <strong>Error:</strong> ${error.message}
                `;
            }
        };

        // 2. Fetch and Display Stats
        async function loadStats() {
            try {
                const response = await fetch('/stats');
                
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }
                
                const links = await response.json();
                
                const tbody = document.getElementById('statsTable');
                tbody.innerHTML = links.map(link => `
                    <tr>
                        <td><a href="/${link.short_code}" target="_blank">${link.short_code}</a></td>
                        <td>${link.original_url.length > 50 ? link.original_url.substring(0, 50) + '...' : link.original_url}</td>
                        <td><strong>${link.click_count}</strong></td>
                        <td><a href="/${link.short_code}" role="button" class="outline">Test</a></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load stats on page load
        loadStats();
    </script>
</body>
</html>
